name: Build and Push Docker Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version of the Docker image"
        required: true
        type: string
        default: "latest"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Replace version placeholder in Dockerfile
        run: | 
          VERSION=${{ github.event.inputs.version }}
          echo "Replacing placeholder with version: $VERSION"
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/" devops/html/index.html 
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: check PWD
        run: pwd

      - name: Build the Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/nginx:${{ github.event.inputs.version }} -f devops/Dockerfile .
      - name: Push the Docker image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/nginx:${{ github.event.inputs.version }}

  trigger-update-tag:
    needs: build-and-push
    uses: ./.github/workflows/reusable-template.yaml
    with:
      file_path: "manifests/apps/entity/base/deployment.yaml"
      search_pattern: "image: .*"
      replace_value: "image: ${{ github.event.inputs.version }}"
      pr_title: "Bump version to ${{ github.event.inputs.version }}"
      pr_body: "Automated update of application version."
      branch_name: "update-tag-${{ github.event.inputs.version }}"
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  slack-notification:
    needs: trigger-update-tag
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.22.0
        with:
          channel-id: 'YOUR_SLACK_CHANNEL_ID'
          text: 'A new PR has been created for version bump to ${{ github.event.inputs.version }}. Please review.'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
